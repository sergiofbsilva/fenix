# Migrating FenixEdu Academic 4.x to 5.0

## Pre-Migration

1. Run the following script to export the currently available DegreeTypes: [DumpDegreeTypes](https://gist.github.com/jcarvalho/00aa8e194603fd26ec1d). Keep the generated file.
2. Run the following script to generate the SQL necessary to create ProgramConclusion objects: [DumpProgramConclusionMigrationSQLTask.java](https://gist.github.com/sergiofbsilva/2f4b88377536a6ff0c68). Keep the generated output.

## Migration

1. Run the following SQL instructions, to initialize the new DegreeType Structures

```sql
-- Degree Types
alter table `ACADEMIC_PROGRAM` add `OID_DEGREE_TYPE` bigint unsigned, add index (OID_DEGREE_TYPE);
alter table `QUEUE_JOB` add `OID_DEGREE_TYPE` bigint unsigned, add index (OID_DEGREE_TYPE);
create table `DEGREE_TYPE` (`DEA` tinyint(1), `CYCLES_TO_ENROL` text, `MASTER_DEGREE` tinyint(1), `CYCLES` text, `OID_BENNU` bigint unsigned, `OID_DOMAIN_META_OBJECT` bigint unsigned, `BOLONHA` tinyint(1), `DEGREE_TYPE` tinyint(1), `OID` bigint unsigned, `EMPTY` tinyint(1), `DFA` tinyint(1), `NAME` text, primary key (OID), index (OID_BENNU), index (OID)) ENGINE=InnoDB, character set utf8;
alter table `CURRICULAR_RULE` add `OID_BOLONHA_DEGREE_TYPE` bigint unsigned, add index (OID_BOLONHA_DEGREE_TYPE);
alter table `PERSISTENT_GROUP` add `OID_DEGREE_TYPE` bigint unsigned, add index (OID_DEGREE_TYPE);

-- Program Conclusions

alter table `CONCLUSION_PROCESS` change `OID_CYCLE` `OID_GROUP` bigint unsigned;
create table `PROGRAM_CONCLUSION` (`GRADUATION_TITLE` text, `GRADUATION_LEVEL` text, `OID_DOMAIN_META_OBJECT` bigint unsigned, `OID_ROOT` bigint unsigned, `EVENT_TYPES` text, `OID` bigint unsigned, `AVERAGE_EDITABLE` tinyint(1), `ALUMNI_PROVIDER` tinyint(1), `TARGET_STATE` text, `NAME` text, primary key (OID), index (OID_ROOT), index (OID)) ENGINE=InnoDB, character set utf8;
alter table `DEGREE_MODULE` add `OID_PROGRAM_CONCLUSION` bigint unsigned, add index (OID_PROGRAM_CONCLUSION);
alter table `ACADEMIC_SERVICE_REQUEST` add `OID_PROGRAM_CONCLUSION` bigint unsigned, add index (OID_PROGRAM_CONCLUSION);

-- Other

alter table `CONCLUSION_PROCESS_VERSION` add `ACTIVE` tinyint(1);
UPDATE `CONCLUSION_PROCESS_VERSION` SET ACTIVE = 1;

UPDATE `DEGREE_MODULE` SET IS_OPTIONAL = 0 WHERE IS_OPTIONAL IS NULL;

UPDATE `FF$DOMAIN_CLASS_INFO` SET DOMAIN_CLASS_NAME = 'org.fenixedu.academic.domain.student.curriculum.ProgramConclusionProcess' where DOMAIN_CLASS_NAME = 'org.fenixedu.academic.domain.student.curriculum.CycleConclusionProcess';

```

2. Run the `degreeTypes.sql` file generated in the Pre-Migration Step 1
3. Run the `programConclusions.sql` file generated in the Pre-Migration Step 2

